/*!
 * FilePondPluginImageTransform 3.3.3
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://pqina.nl/filepond/ for details.
 */

/* eslint-disable */

const t={jpeg:"jpg","svg+xml":"svg"},e={1:()=>[1,0,0,1,0,0],2:t=>[-1,0,0,1,t,0],3:(t,e)=>[-1,0,0,-1,t,e],4:(t,e)=>[1,0,0,-1,0,e],5:()=>[0,1,1,0,0,0],6:(t,e)=>[0,1,-1,0,e,0],7:(t,e)=>[0,-1,-1,0,e,t],8:t=>[0,-1,1,0,0,t]},n=(t,e)=>({x:t,y:e}),i=(t,e)=>n(t.x-e.x,t.y-e.y),a=(t,e)=>Math.sqrt(((t,e)=>((t,e)=>t.x*e.x+t.y*e.y)(i(t,e),i(t,e)))(t,e)),o=(t,e)=>{const i=t,a=e,o=1.5707963267948966-e,r=Math.sin(1.5707963267948966),l=Math.sin(a),s=Math.sin(o),h=Math.cos(o),c=i/r;return n(h*(c*l),h*(c*s))},r=(t,e,i=0,r={x:.5,y:.5})=>{const l=r.x>.5?1-r.x:r.x,s=r.y>.5?1-r.y:r.y,h=2*l*t.width,c=2*s*t.height,d=((t,e)=>{const i=t.width,r=t.height,l=o(i,e),s=o(r,e),h=n(t.x+Math.abs(l.x),t.y-Math.abs(l.y)),c=n(t.x+t.width+Math.abs(s.y),t.y+Math.abs(s.x)),d=n(t.x-Math.abs(s.y),t.y+t.height-Math.abs(s.x));return{width:a(h,c),height:a(h,d)}})(e,i);return Math.max(d.width/h,d.height/c)},l=(t,e)=>{let n=t.width,i=n*e;return i>t.height&&(n=(i=t.height)/e),{x:.5*(t.width-n),y:.5*(t.height-i),width:n,height:i}},s=t=>t&&(t.horizontal||t.vertical),h=(t,n,i)=>{if(!n&&!s(i))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;const a=document.createElement("canvas"),o=t.naturalWidth,r=t.naturalHeight,l=n>=5&&n<=8;l?(a.width=r,a.height=o):(a.width=o,a.height=r);const h=a.getContext("2d");if(n&&h.transform.apply(h,((t,n,i)=>(-1===i&&(i=1),e[i](t,n)))(o,r,n)),s(i)){const t=[1,0,0,1,0,0];(!l&&i.horizontal||l&i.vertical)&&(t[0]=-1,t[4]=o),(!l&&i.vertical||l&&i.horizontal)&&(t[3]=-1,t[5]=r),h.transform(...t)}return h.drawImage(t,0,0,o,r),a},c=(t,e,n={})=>{const i=n.zoom||1,a=h(t,e,n.flip),o={width:a.width,height:a.height},s=document.createElement("canvas"),c=n.aspectRatio||o.height/o.width,d=((t,e,n=1)=>{const i=t.height/t.width;let a=e,o=1,r=i;r>a&&(o=(r=a)/i);const l=Math.max(1/o,a/r),s=t.width/(n*l*o);return{width:s,height:s*e}})(o,c,i),u={x:.5*d.width,y:.5*d.height},g={x:0,y:0,width:d.width,height:d.height,center:u},m=i*r(o,l(g,c),n.rotation,n.center);s.width=Math.round(d.width/m),s.height=Math.round(d.height/m),u.x/=m,u.y/=m;const p=u.x-o.width*(n.center?n.center.x:.5),f=u.y-o.height*(n.center?n.center.y:.5),w=s.getContext("2d");return w.translate(u.x,u.y),w.rotate(n.rotation||0),w.drawImage(a,p-u.x,f-u.y,o.width,o.height),w.getImageData(0,0,s.width,s.height)};(()=>"undefined"!=typeof window&&void 0!==window.document)()&&(HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,n){var i=this.toDataURL(e,n).split(",")[1];setTimeout(function(){for(var n=atob(i),a=n.length,o=new Uint8Array(a),r=0;r<a;r++)o[r]=n.charCodeAt(r);t(new Blob([o],{type:e||"image/png"}))})}}));const d=()=>{const t={resize:function(t,e){let{mode:i="contain",upscale:r=!1,width:l,height:s,matrix:h}=e;if(h=!h||a(h)?null:h,!l&&!s)return o(t,h);null===l?l=s:null===s&&(s=l);if("force"!==i){let e=l/t.width,n=s/t.height,a=1;if("cover"===i?a=Math.max(e,n):"contain"===i&&(a=Math.min(e,n)),a>1&&!1===r)return o(t,h);l=t.width*a,s=t.height*a}const c=t.width,d=t.height,u=Math.round(l),g=Math.round(s),m=t.data,p=new Uint8ClampedArray(u*g*4),f=c/u,w=d/g,y=Math.ceil(.5*f),M=Math.ceil(.5*w);for(let t=0;t<g;t++)for(let e=0;e<u;e++){let i=4*(e+t*u),a=0,o=0,r=0,l=0,s=0,d=0,g=0,T=(t+.5)*w;for(let n=Math.floor(t*w);n<(t+1)*w;n++){let t=Math.abs(T-(n+.5))/M,i=(e+.5)*f,h=t*t;for(let t=Math.floor(e*f);t<(e+1)*f;t++){let e=Math.abs(i-(t+.5))/y,u=Math.sqrt(h+e*e);if(u>=-1&&u<=1&&(a=2*u*u*u-3*u*u+1)>0){let i=m[(e=4*(t+n*c))+3];g+=a*i,r+=a,i<255&&(a=a*i/250),l+=a*m[e],s+=a*m[e+1],d+=a*m[e+2],o+=a}}}p[i]=l/o,p[i+1]=s/o,p[i+2]=d/o,p[i+3]=g/r,h&&n(i,p,h)}return{data:p,width:u,height:g}},filter:o},e=(e,n)=>{let i=e.transforms,a=null;if(i.forEach(t=>{"filter"===t.type&&(a=t)}),a){let t=null;i.forEach(e=>{"resize"===e.type&&(t=e)}),t&&(t.data.matrix=a.data,i=i.filter(t=>"filter"!==t.type))}n(((e,n)=>(e.forEach(e=>{n=t[e.type](n,e.data)}),n))(i,e.imageData))};function n(t,e,n){let i=0,a=0,o=0,r=e[t]/255,l=e[t+1]/255,s=e[t+2]/255,h=e[t+3]/255;for(;i<4;i++)o=255*(r*n[a=5*i]+l*n[a+1]+s*n[a+2]+h*n[a+3]+n[a+4]),e[t+i]=Math.max(0,Math.min(o,255))}self.onmessage=(t=>{e(t.data.message,e=>{self.postMessage({id:t.data.id,message:e},[e.data.buffer])})});const i=JSON.stringify([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0]);function a(t){return JSON.stringify(t||[])===i}function o(t,e){if(!e||a(e))return t;const n=t.data,i=n.length,o=e[0],r=e[1],l=e[2],s=e[3],h=e[4],c=e[5],d=e[6],u=e[7],g=e[8],m=e[9],p=e[10],f=e[11],w=e[12],y=e[13],M=e[14],T=e[15],A=e[16],x=e[17],R=e[18],E=e[19];let b=0,_=0,v=0,I=0,O=0;for(;b<i;b+=4)_=n[b]/255,v=n[b+1]/255,I=n[b+2]/255,O=n[b+3]/255,n[b]=Math.max(0,Math.min(255*(_*o+v*r+I*l+O*s+h),255)),n[b+1]=Math.max(0,Math.min(255*(_*c+v*d+I*u+O*g+m),255)),n[b+2]=Math.max(0,Math.min(255*(_*p+v*f+I*w+O*y+M),255)),n[b+3]=Math.max(0,Math.min(255*(_*T+v*A+I*x+O*R+E),255));return t}},u=(t,e,n)=>{if(1165519206!==t.getUint32(e+4,!1))return;e+=4;const i=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,i);const a=t.getUint16(e,i);e+=2;for(let n=0;n<a;n++)if(274===t.getUint16(e+12*n,i))return t.setUint16(e+12*n+8,1,i),!0;return!1},g=t=>new Promise((e,n)=>{const i=new FileReader;i.onload=(()=>e((t=>{const e=new DataView(t);if(65496!==e.getUint16(0))return null;let n,i,a=2,o=!1;for(;a<e.byteLength&&(n=e.getUint16(a,!1),i=e.getUint16(a+2,!1)+2,n>=65504&&n<=65519||65534===n)&&(o||(o=u(e,a)),!(a+i>e.byteLength));)a+=i;return t.slice(0,a)})(i.result)||null)),i.readAsArrayBuffer(t.slice(0,262144))}),m=(t,e)=>{const n=(()=>window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)();if(n){const i=new n;return i.append(t),i.getBlob(e)}return new Blob([t],{type:e})},p=t=>{const e=new Blob(["(",t.toString(),")()"],{type:"application/javascript"}),n=URL.createObjectURL(e),i=new Worker(n);return{transfer:(t,e)=>{},post:(t,e,n)=>{const a=(()=>Math.random().toString(36).substr(2,9))();i.onmessage=(t=>{t.data.id===a&&e(t.data.message)}),i.postMessage({id:a,message:t},n)},terminate:()=>{i.terminate(),URL.revokeObjectURL(n)}}},f=(t,e,n={})=>new Promise((i,a)=>{if(!t||!(t=>/^image/.test(t.type))(t))return a();const{stripImageHead:o,beforeCreateBlob:s,afterCreateBlob:h}=n,{crop:u,size:f,filter:w,output:y}=e,M=e.image&&e.image.orientation?Math.max(1,Math.min(8,e.image.orientation)):null,T=y&&y.quality,A=null===T?null:T/100,x=y&&y.type||null,R=[];!f||"number"!=typeof f.width&&"number"!=typeof f.height||R.push({type:"resize",data:f}),w&&20===w.length&&R.push({type:"filter",data:w});const E=t=>{const e=h?h(t):t;Promise.resolve(e).then(i)},b=(e,n)=>((t,e,n=null)=>new Promise(i=>{const a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").putImageData(t,0,0);const o=n?n(a):a;Promise.resolve(o).then(t=>{t.toBlob(i,e.type,e.quality)})}))(e,n,s).then(e=>{if(o)return E(e);g(t).then(t=>{null!==t&&(e=new Blob([t,e.slice(20)],{type:e.type})),E(e)})}).catch(a);if(/svg/.test(t.type)&&null===x)return((t,e={center:{x:.5,y:.5},zoom:1,rotation:0,flip:{horizontal:!1,vertical:!1,aspectRatio:null}})=>new Promise(n=>{const i=new FileReader;i.onloadend=(()=>{const t=i.result,a=document.createElement("div");a.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",a.innerHTML=t;const o=a.querySelector("svg");document.body.appendChild(a);const s=o.getBBox();a.parentNode.removeChild(a);const h=a.querySelector("title"),c=o.getAttribute("viewBox")||"",d=o.getAttribute("width")||"",u=o.getAttribute("height")||"";let g=parseFloat(d)||null,m=parseFloat(u)||null;const p=(d.match(/[a-z]+/)||[])[0]||"",f=(u.match(/[a-z]+/)||[])[0]||"",w=c.split(" ").map(parseFloat),y=w.length?{x:w[0],y:w[1],width:w[2],height:w[3]}:s;let M=null!=g?g:y.width,T=null!=m?m:y.height;o.style.overflow="visible",o.setAttribute("width",M),o.setAttribute("height",T);const A=e.aspectRatio||T/M,x=M,R=x*A,E=r({width:M,height:T},l({width:x,height:R},A),e.rotation,e.center),b=e.zoom*E,_=.5*x,v=.5*R,I=[`rotate(${e.rotation*(180/Math.PI)} ${_} ${v})`,`translate(${_} ${v})`,`scale(${b})`,`translate(${-_} ${-v})`,`translate(${_-M*e.center.x} ${v-T*e.center.y})`],O=[`scale(${e.flip.horizontal?-1:1} ${e.flip.vertical?-1:1})`,`translate(${e.flip.horizontal?-M:0} ${e.flip.vertical?-T:0})`],U=`<?xml version="1.0" encoding="UTF-8"?>\n<svg width="${x}${p}" height="${R}${f}" \nviewBox="0 0 ${x} ${R}" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: PQINA - https://pqina.nl/ --\x3e\n<title>${h?h.textContent:""}</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="${I.join(" ")}">\n<g transform="${O.join(" ")}">\n${o.outerHTML}\n</g>\n</g>\n</svg>`;n(U)}),i.readAsText(t)}))(t,u).then(t=>{i(m(t,"image/svg+xml"))});const _=URL.createObjectURL(t);(t=>new Promise((e,n)=>{const i=new Image;i.onload=(()=>{e(i)}),i.onerror=(t=>{n(t)}),i.src=t}))(_).then(e=>{URL.revokeObjectURL(_);const n=c(e,M,u),i={quality:A,type:x||t.type};if(!R.length)return b(n,i);const a=p(d);a.post({transforms:R,imageData:n},t=>{b((t=>{let e;try{e=new ImageData(t.width,t.height)}catch(n){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e})(t),i),a.terminate()},[n.data.buffer])})});"undefined"!=typeof window&&void 0!==window.document&&(HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,n){const i=this;setTimeout(()=>{const a=i.toDataURL(e,n).split(",")[1],o=atob(a);let r=o.length;const l=new Uint8Array(r);for(;r--;)l[r]=o.charCodeAt(r);t(new Blob([l],{type:e||"image/png"}))})}}));const w=({addFilter:e,utils:n})=>{const{Type:i,forin:a,getFileFromBlob:o,isFile:r}=n,l=["crop","resize","filter","output"],s=t=>null===t.aspectRatio&&0===t.rotation&&1===t.zoom&&t.center&&.5===t.center.x&&.5===t.center.y&&t.flip&&!1===t.flip.horizontal&&!1===t.flip.vertical;return e("SHOULD_PREPARE_OUTPUT",(t,{query:e})=>new Promise(t=>{t(!e("IS_ASYNC"))})),e("PREPARE_OUTPUT",(e,{query:n,item:i})=>new Promise(h=>{if(!r(e)||!(t=>/^image/.test(t.type))(e)||!n("GET_ALLOW_IMAGE_TRANSFORM")||i.archived)return h(e);const c=[];n("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_ORIGINAL")&&c.push(()=>new Promise(t=>{t({name:n("GET_IMAGE_TRANSFORM_VARIANTS_ORIGINAL_NAME"),file:e})})),n("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_DEFAULT")&&c.push((t,e,i)=>new Promise(a=>{t(e,i).then(t=>a({name:n("GET_IMAGE_TRANSFORM_VARIANTS_DEFAULT_NAME"),file:t}))}));const d=n("GET_IMAGE_TRANSFORM_VARIANTS")||{};a(d,(t,e)=>{const n=(t=>(e,n,i)=>e(n,t?t(i):i))(e);c.push((e,i,a)=>new Promise(o=>{n(e,i,a).then(e=>o({name:t,file:e}))}))});const u=n("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),g=n("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),m=null===u?null:u/100,p=n("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),w=n("GET_IMAGE_TRANSFORM_CLIENT_TRANSFORMS")||l;i.setMetadata("output",{type:p,quality:m,client:w},!0);const y=(e,i)=>new Promise((a,r)=>{const l={...i};Object.keys(l).filter(t=>"exif"!==t).forEach(t=>{-1===w.indexOf(t)&&delete l[t]});const{resize:h,exif:c,output:d,crop:u,filter:m}=l,p={image:{orientation:c?c.orientation:null},output:d?{type:d.type,quality:d.quality?100*d.quality:null}:void 0,size:h&&(h.size.width||h.size.height)?{mode:h.mode,upscale:h.upscale,...h.size}:void 0,crop:u&&!s(u)?{...u}:void 0,filter:m};if(p.output){const t=d.type&&d.type!==e.type,n=!!(p.size||p.crop||p.filter||t);if(d.quality&&"optional"===g&&!n)return a(e)}const y={stripImageHead:n("GET_IMAGE_TRANSFORM_OUTPUT_STRIP_IMAGE_HEAD")};f(e,p,y).then(n=>{const i=o(n,((e,n)=>{const i=(t=>t.substr(0,t.lastIndexOf("."))||t)(e),a=n.split("/")[1];return`${i}.${t[a]||a}`})(e.name,(t=>/jpeg|png|svg\+xml/.test(t)?t:"image/jpeg")(n.type)));a(i)}).catch(r)}),M=c.map(t=>t(y,e,i.getMetadata()));Promise.all(M).then(t=>{h(1===t.length&&null===t[0].name?t[0].file:t)})})),{options:{allowImageTransform:[!0,i.BOOLEAN],imageTransformOutputMimeType:[null,i.STRING],imageTransformOutputQuality:[null,i.INT],imageTransformOutputStripImageHead:[!0,i.BOOLEAN],imageTransformClientTransforms:[null,i.ARRAY],imageTransformOutputQualityMode:["always",i.STRING],imageTransformVariants:[null,i.OBJECT],imageTransformVariantsIncludeDefault:[!0,i.BOOLEAN],imageTransformVariantsDefaultName:[null,i.STRING],imageTransformVariantsIncludeOriginal:[!1,i.BOOLEAN],imageTransformVariantsOriginalName:["original_",i.STRING]}}};"undefined"!=typeof window&&void 0!==window.document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:w}));export default w;
